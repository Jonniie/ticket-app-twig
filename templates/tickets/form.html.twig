{% extends 'base.html.twig' %}

{% block title %}{{ isEdit ? 'Edit Ticket' : 'Create Ticket' }} - TicketApp{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl mx-auto">
        <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-8">
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-black">
                    {% if isEdit %}
                        Edit Ticket
                    {% else %}
                        Create New Ticket
                    {% endif %}
                </h2>
                <p class="text-gray-600 mt-1">
                    {% if isEdit %}
                        Update the ticket details below.
                    {% else %}
                        Fill in the details to create a new ticket.
                    {% endif %}
                </p>
            </div>

            {% if toasts|length > 0 %}
                {% for toast in toasts %}
                    {% if toast.type == 'error' %}
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 flex items-center space-x-2 mb-6">
                            <svg class="w-5 h-5 text-red-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4v2m0-12a9 9 0 110 18 9 9 0 010-18z"></path>
                            </svg>
                            <span class="text-red-800 text-sm">{{ toast.message }}</span>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endif %}

            <form onsubmit="return validateForm()" method="POST" action="{% if isEdit %}/tickets/{{ ticket.id }}/update{% else %}/tickets/create{% endif %}" class="space-y-6">
                <!-- Title -->
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                        Title *
                    </label>
                    <input
                        type="text"
                        id="title"
                        name="title"
                        value="{% if isEdit %}{{ ticket.title }}{% endif %}"
                        class="input-field"
                        placeholder="Enter ticket title"
                        required
                    />
                    <p id="titleError" class="mt-1 text-sm text-red-600 hidden"></p>
                </div>

                <!-- Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                        Description
                    </label>
                    <textarea
                        id="description"
                        name="description"
                        rows="4"
                        class="input-field resize-none"
                        placeholder="Enter ticket description (optional)"
                        maxlength="1000"
                    >{% if isEdit %}{{ ticket.description }}{% endif %}</textarea>
                    <p id="descriptionError" class="mt-1 text-sm text-red-600 hidden"></p>
                    <p class="mt-1 text-xs text-gray-500">
                        <span id="charCount">0</span>/1000 characters
                    </p>
                </div>

                <!-- Status and Priority -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
                            Status {% if !isEdit %}(Auto-set to Open){% endif %}*
                        </label>
                        <select
                            id="status"
                            name="status"
                            class="input-field"
                            {% if !isEdit %}disabled{% endif %}
                        >
                            <option value="open" {% if !isEdit || ticket.status == 'open' %}selected{% endif %}>Open</option>
                            <option value="in_progress" {% if isEdit && ticket.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                            <option value="closed" {% if isEdit && ticket.status == 'closed' %}selected{% endif %}>Closed</option>
                        </select>
                        <p id="statusError" class="mt-1 text-sm text-red-600 hidden"></p>
                        {% if !isEdit %}
                            <p class="mt-1 text-xs text-gray-500">
                                New tickets are automatically set to "Open" status
                            </p>
                        {% endif %}
                    </div>

                    <div>
                        <label for="priority" class="block text-sm font-medium text-gray-700 mb-2">
                            Priority
                        </label>
                        <select
                            id="priority"
                            name="priority"
                            class="input-field"
                        >
                            <option value="low" {% if isEdit && ticket.priority == 'low' %}selected{% else %}{% if !isEdit %}{% endif %}{% endif %}>Low</option>
                            <option value="medium" {% if isEdit && ticket.priority == 'medium' %}selected{% else %}selected{% endif %}>Medium</option>
                            <option value="high" {% if isEdit && ticket.priority == 'high' %}selected{% endif %}>High</option>
                        </select>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex items-center justify-end space-x-4 pt-6 border-t border-gray-200">
                    <a href="/tickets" class="btn-secondary">
                        Cancel
                    </a>
                    <button
                        type="submit"
                        class="btn-primary"
                    >
                        {% if isEdit %}
                            Update Ticket
                        {% else %}
                            Create Ticket
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Update character count
document.getElementById('description').addEventListener('input', function() {
    document.getElementById('charCount').textContent = this.value.length;
});

// Initialize character count on page load
document.addEventListener('DOMContentLoaded', function() {
    const desc = document.getElementById('description');
    document.getElementById('charCount').textContent = desc.value.length;
});

function validateForm() {
    // Clear previous errors
    document.getElementById('titleError').classList.add('hidden');
    document.getElementById('descriptionError').classList.add('hidden');
    document.getElementById('statusError').classList.add('hidden');
    
    let isValid = true;
    
    // Validate title
    const title = document.getElementById('title').value.trim();
    if (!title) {
        document.getElementById('titleError').textContent = 'Title is required';
        document.getElementById('titleError').classList.remove('hidden');
        isValid = false;
    }
    
    // Validate description
    const description = document.getElementById('description').value;
    if (description.length > 1000) {
        document.getElementById('descriptionError').textContent = 'Description must be less than 1000 characters';
        document.getElementById('descriptionError').classList.remove('hidden');
        isValid = false;
    }
    
    // Validate status
    const status = document.getElementById('status').value;
    if (!['open', 'in_progress', 'closed'].includes(status)) {
        document.getElementById('statusError').textContent = 'Invalid status selected';
        document.getElementById('statusError').classList.remove('hidden');
        isValid = false;
    }
    
    return isValid;
}
</script>
{% endblock %}
